<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydroponic Dashboard - Portfolio Project</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            --gradient-bg: linear-gradient(135deg, #03045E, #023E8A, #0077B6, #0096C7);
            --text-light: #caf0f8;
            --text-dark-primary: #023e8a;
            --text-dark-secondary: #0077b6;
            --glow-color: #48cae4;
            --card-bg: linear-gradient(150deg, rgba(255, 255, 255, 0.95), rgba(202, 240, 248, 0.9));
            --card-border: rgba(255, 255, 255, 0.4);
            --ease-out-quint: cubic-bezier(0.22, 1, 0.36, 1);
            --duration-medium: 300ms;
            --duration-slow: 500ms;
        }
        * { box-sizing: border-box; }
        body {
            font-family: var(--font-family);
            line-height: 1.7;
            background: var(--gradient-bg);
            background-size: 200% 200%;
            animation: gradientFlow 15s ease infinite;
            color: var(--text-light);
            min-height: 100vh;
            padding: clamp(0.5rem, 2vw, 2rem) clamp(0.5rem, 2vw, 1rem);
            margin: 0;
        }
        @keyframes gradientFlow { 
            0% { background-position: 0% 50%; } 
            50% { background-position: 100% 50%; } 
            100% { background-position: 0% 50%; } 
        }
        .container { max-width: 1400px; margin: 0 auto; width: 100%; }
        .page-header { text-align: center; margin-bottom: clamp(2rem, 4vw, 3rem); position: relative; padding-top: clamp(2rem, 6vw, 4rem); }
        .page-header h1 { font-size: clamp(2.5rem, 6vw, 4rem); font-weight: 800; background: linear-gradient(45deg, var(--text-light), var(--glow-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem; line-height: 1.1; }
        .page-header .subtitle { font-size: clamp(1rem, 2.5vw, 1.3rem); font-weight: 500; opacity: 0.9; }
        .dashboard-grid { display: grid; grid-template-columns: minmax(0, 2fr) minmax(0, 1fr); gap: clamp(1rem, 3vw, 2rem); }
        .glass-card {
            background: var(--card-bg);
            border-radius: clamp(15px, 3vw, 20px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: transform var(--duration-medium) var(--ease-out-quint);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--card-border);
            color: var(--text-dark-secondary);
            margin-bottom: clamp(1rem, 3vw, 2rem);
            opacity: 0;
            transform: translateY(20px);
            animation: slideInUp var(--duration-slow) var(--ease-out-quint) forwards;
            min-height: clamp(300px, 40vh, 400px);
        }
        .glass-card::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: inherit; padding: 2px; background: linear-gradient(135deg, var(--glow-color), transparent, var(--glow-color)); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; z-index: 1; opacity: 0; transition: opacity var(--duration-medium) var(--ease-out-quint); }
        .glass-card:hover { transform: translateY(-4px) scale(1.01); }
        .glass-card:hover::before { opacity: 1; animation: spin 3s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .main-content .glass-card:nth-of-type(1) { animation-delay: 100ms; }
        .main-content .glass-card:nth-of-type(2) { animation-delay: 300ms; }
        .sidebar-content .glass-card:nth-of-type(1) { animation-delay: 200ms; }
        .sidebar-content .glass-card:nth-of-type(2) { animation-delay: 400ms; }
        @keyframes slideInUp { to { opacity: 1; transform: translateY(0); } }
        .card-content { padding: clamp(1.25rem, 4vw, 2.5rem); z-index: 2; height: 100%; display: flex; flex-direction: column; }
        .card-content h2 { font-size: clamp(1.4rem, 4vw, 2.2rem); font-weight: 800; color: var(--text-dark-primary); margin-bottom: clamp(1rem, 3vw, 1.5rem); padding-bottom: 0.5rem; display: inline-block; position: relative; }
        .card-content h2::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background: var(--glow-color); transform-origin: center; animation: pulseUnderline 3s ease-in-out infinite; }
        @keyframes pulseUnderline { 0%, 100% { transform: scaleX(1); opacity: 0.8; } 50% { transform: scaleX(1.03); opacity: 1; } }
        .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(clamp(120px, 25vw, 140px), 1fr)); gap: clamp(0.75rem, 2vw, 1.5rem); }
        .metric-card { background: rgba(255,255,255,0.5); border-radius: clamp(10px, 2vw, 15px); padding: clamp(1rem, 3vw, 1.5rem); text-align: center; }
        .metric-card .value { font-size: clamp(1.5rem, 4vw, 2.5rem); font-weight: 800; color: var(--text-dark-primary); line-height: 1; margin-bottom: 0.25rem; }
        .metric-card .label { font-size: clamp(0.75rem, 2.2vw, 1rem); font-weight: 500; line-height: 1.3; }
        .achievement-list { list-style-type: none; padding-left: 0; margin-top: clamp(1rem, 3vw, 1.5rem); }
        .achievement-item { display: flex; align-items: flex-start; gap: clamp(0.75rem, 2vw, 1rem); background: rgba(255,255,255,0.6); padding: clamp(0.75rem, 2vw, 1rem); border-radius: clamp(8px, 2vw, 12px); margin-bottom: clamp(0.75rem, 2vw, 1rem); }
        .achievement-icon { flex-shrink: 0; width: clamp(32px, 6vw, 40px); height: clamp(32px, 6vw, 40px); display: grid; place-items: center; border-radius: clamp(6px, 1.5vw, 8px); }
        .achievement-icon svg { width: clamp(20px, 4vw, 28px); height: clamp(20px, 4vw, 28px); }
        .achievement-text strong { color: var(--text-dark-primary); font-size: clamp(0.85rem, 2.2vw, 1.1rem); font-weight: 700; display: block; line-height: 1.3; }
        .achievement-text p { font-size: clamp(0.75rem, 2vw, 0.9rem); line-height: 1.4; margin: 0.25rem 0 0 0; }
        .analysis-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: clamp(0.75rem, 2vw, 1rem); margin-bottom: clamp(1rem, 3vw, 1.5rem); }
        .chart-toggle { background-color: rgba(255,255,255,0.2); border-radius: 25px; padding: clamp(0.2rem, 0.5vw, 0.25rem); display: inline-flex; gap: clamp(0.2rem, 0.5vw, 0.25rem); }
        .toggle-button { font-family: var(--font-family); background: transparent; border: none; padding: clamp(0.4rem, 1vw, 0.5rem) clamp(0.75rem, 2vw, 1rem); border-radius: 25px; font-size: clamp(0.75rem, 2vw, 0.9rem); font-weight: 700; color: var(--text-dark-secondary); cursor: pointer; transition: all 0.3s var(--ease-out-quint); }
        .toggle-button.active { background-color: white; color: var(--text-dark-primary); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .plant-selector { display: grid; grid-template-columns: repeat(auto-fill, minmax(clamp(80px, 15vw, 120px), 1fr)); gap: clamp(0.3rem, 1vw, 0.5rem); margin-bottom: clamp(1rem, 3vw, 1.5rem); }
        .plant-button { background-color: rgba(0,0,0,0.05); color: var(--text-dark-secondary); border: 1px solid transparent; padding: clamp(0.5rem, 1.5vw, 0.75rem); border-radius: clamp(6px, 1.5vw, 8px); font-weight: 700; cursor: pointer; text-align: center; transition: all 0.2s; font-size: clamp(0.7rem, 1.8vw, 0.9rem); }
        .plant-button.active { background-color: var(--text-dark-primary); color: white; }
        .chart-view { display: none; }
        .chart-view.active { display: block; }
        .table-container { flex-grow: 1; overflow: auto; max-height: clamp(300px, 50vh, 400px); }
        .performance-table { width: 100%; border-collapse: collapse; font-family: var(--font-family); font-size: clamp(0.75rem, 1.8vw, 0.9rem); }
        .performance-table th, .performance-table td { padding: clamp(0.4rem, 1.2vw, 0.75rem) clamp(0.6rem, 1.8vw, 1rem); text-align: left; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .performance-table th { font-weight: 700; color: var(--text-dark-primary); position: sticky; top: 0; background: var(--card-bg); font-size: clamp(0.75rem, 1.8vw, 0.9rem); }
        .performance-table td { font-weight: 500; }
        .performance-table tbody tr:nth-child(even) { background-color: rgba(0,0,0,0.02); }
        .performance-table .flagship-row { background-color: rgba(72, 202, 228, 0.1); }
        .performance-table .growth-positive { color: #0f5132; font-weight: 700; }
        .cta-button { display: inline-block; background-color: #0096c7; color: white; padding: clamp(0.6rem, 1.8vw, 0.75rem) clamp(1rem, 3vw, 1.5rem); border-radius: 25px; text-decoration: none; font-weight: 700; font-size: clamp(0.75rem, 1.8vw, 0.9rem); transition: all 0.3s var(--ease-out-quint); }
        .cta-button:hover { background-color: var(--text-dark-primary); transform: translateY(-2px); }
        .back-button { position: absolute; top: clamp(1rem, 3vw, 2rem); left: clamp(1rem, 3vw, 2rem); z-index: 10; }
        @media (max-width: 1200px) { .dashboard-grid { grid-template-columns: minmax(0, 3fr) minmax(0, 2fr); gap: clamp(1rem, 2.5vw, 1.5rem); } }
        @media (max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; gap: 1rem; } .page-header { padding-top: clamp(1.5rem, 4vw, 2rem); } .analysis-header { flex-direction: column; align-items: flex-start; gap: 0.75rem; } .chart-toggle { align-self: stretch; } .toggle-button { flex: 1; text-align: center; } }
        @media (max-width: 600px) { body { padding: 0.5rem; } .glass-card { margin-bottom: 0.75rem; min-height: clamp(250px, 35vh, 300px); } .metric-grid { grid-template-columns: 1fr 1fr; gap: 0.5rem; } .plant-selector { grid-template-columns: repeat(4, 1fr); gap: 0.25rem; } .achievement-item { flex-direction: row; align-items: center; gap: 0.5rem; } .achievement-icon { width: 28px; height: 28px; } .achievement-icon svg { width: 18px; height: 18px; } }
        @media (max-width: 400px) { .plant-selector { grid-template-columns: repeat(3, 1fr); } .metric-grid { grid-template-columns: 1fr; gap: 0.5rem; } .performance-table { font-size: 0.7rem; } .performance-table th, .performance-table td { padding: 0.3rem 0.4rem; } }
        .chart-view canvas { width: 100% !important; height: 300px !important; max-height: 400px; }
        @media (max-width: 600px) { .chart-view canvas { height: 250px !important; } }
    </style>
</head>
<body>
    <div class="container">
        <header class="page-header">
            <a href="hydroponic_timeline.html" class="cta-button back-button">‚Üê Back to Timeline</a>
            <h1>Hydroponic Dashboard</h1>
            <p class="subtitle">Real-time Growth Data for Nai Miris Cultivation</p>
        </header>

        <main class="dashboard-grid">
            <div class="main-content">
                 <div class="glass-card">
                     <div class="card-content">
                        <div class="analysis-header">
                            <h2>Growth Analysis</h2>
                            <div class="chart-toggle" id="chart-toggle-container">
                                <button class="toggle-button active" data-chart="timeline">Timeline</button>
                                <button class="toggle-button" data-chart="comparison">Comparison</button>
                                <button class="toggle-button" data-chart="branches">Branches</button>
                            </div>
                        </div>
                        
                        <div id="view-timeline" class="chart-view active">
                            <div class="plant-selector" id="plant-selector-container"></div>
                            <canvas id="growthChart"></canvas>
                        </div>

                        <div id="view-comparison" class="chart-view">
                            <canvas id="comparisonChart"></canvas>
                        </div>
                        <div id="view-branches" class="chart-view">
                            <canvas id="branchChart"></canvas>
                        </div>
                     </div>
                </div>
                <div class="glass-card">
                     <div class="card-content">
                        <h2>Performance Data</h2>
                        <div class="table-container">
                            <table class="performance-table">
                                <thead>
                                    <tr>
                                        <th>Plant No.</th>
                                        <th>Initial (cm)</th>
                                        <th>Final (cm)</th>
                                        <th>Growth</th>
                                    </tr>
                                </thead>
                                <tbody id="performance-table-body"></tbody>
                            </table>
                        </div>
                     </div>
                </div>
            </div>
            <div class="sidebar-content">
                <div class="glass-card">
                    <div class="card-content">
                        <h2>Key Metrics</h2>
                        <div class="metric-grid">
                            <div class="metric-card">
                                <div class="value"><span id="metric-max-size">0</span> cm</div>
                                <div class="label">Flagship Plant (#2)</div>
                            </div>
                            <div class="metric-card">
                                <div class="value"><span id="metric-avg-size">0</span> cm</div>
                                <div class="label">System Average Height</div>
                            </div>
                            <div class="metric-card">
                                <div class="value">45%+</div>
                                <div class="label">Sustained Weekly Growth</div>
                            </div>
                            <div class="metric-card">
                                <div class="value" id="metric-days">0</div>
                                <div class="label">Days Running</div>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="glass-card">
                    <div class="card-content">
                        <h2>Key Achievements</h2>
                        <ul class="achievement-list">
                            <li class="achievement-item">
                                <div class="achievement-icon" style="color: #10b981"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg></div>
                                <div class="achievement-text"><strong>Exceptional Growth</strong><p>Sustained 45%+ weekly growth rate.</p></div>
                            </li>
                             <li class="achievement-item">
                                <div class="achievement-icon" style="color: #8b5cf6"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg></div>
                                <div class="achievement-text"><strong>Zero Deficiencies</strong><p>40+ consecutive days with no nutrient issues.</p></div>
                            </li>
                             <li class="achievement-item">
                                <div class="achievement-icon" style="color: #f59e0b"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></div>
                                <div class="achievement-text"><strong>Accelerated Flowering</strong><p>First branching in 5 weeks vs. 16 in soil.</p></div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // Fetch and parse the JSON data
            fetch('hydroponic_data.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    // This one line does all the parsing!
                    return response.json(); 
                })
                .then(rawData => {
                    // The data is already a perfect JavaScript array of objects
                    initializeDashboard(rawData);
                })
                .catch(error => {
                    console.error('Error loading or parsing JSON data:', error);
                    alert('Failed to load plant data. Please ensure hydroponic_data.json is in the same directory and is accessible.');
                });

            function initializeDashboard(rawData) {
                let selectedPlants = [2, 7, 9];
                let growthChartInstance, comparisonChartInstance, branchChartInstance;
                let activeChart = 'timeline';

                const LATEST_DATE = '2025/9/18';
                const START_DATE = '2025/8/2';
                
                const getDayNumber = (dateStr) => {
                    const startDate = new Date(START_DATE).getTime();
                    const currentDate = new Date(dateStr).getTime();
                    return Math.floor((currentDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                };

                const latestDataAll = rawData.filter(d => d.date === LATEST_DATE);
                const avgSize = 47.4; 
                const maxSize = Math.max(...latestDataAll.map(p => p.size));
                const daysRunning = Math.floor((new Date(LATEST_DATE).getTime() - new Date(START_DATE).getTime()) / (1000 * 60 * 60 * 24));
                
                const plantSelectorContainer = document.getElementById('plant-selector-container');
                const performanceTableBody = document.getElementById('performance-table-body');
                const chartToggleContainer = document.getElementById('chart-toggle-container');

                function renderMetrics() {
                    document.getElementById('metric-max-size').innerText = maxSize;
                    document.getElementById('metric-avg-size').innerText = avgSize;
                    document.getElementById('metric-days').innerText = daysRunning;
                }

                function renderPlantSelector() {
                    plantSelectorContainer.innerHTML = '';
                    for (let i = 1; i <= 16; i++) {
                        const button = document.createElement('button');
                        button.className = `plant-button ${selectedPlants.includes(i) ? 'active' : ''}`;
                        button.innerText = `Plant #${i}`;
                        button.dataset.plantNo = i;
                        plantSelectorContainer.appendChild(button);
                    }
                }

                function renderPerformanceTable() {
                    performanceTableBody.innerHTML = '';
                    const firstDate = START_DATE;
                    for(let i = 1; i <= 16; i++) {
                        const initial = rawData.find(d => d.date === firstDate && d.plantNo === i);
                        const plantData = rawData.filter(d => d.plantNo === i).sort((a,b) => new Date(b.date) - new Date(a.date));
                        const final = plantData[0]; 

                        if(!initial || !final) continue;

                        const growth = ((final.size - initial.size) / initial.size * 100).toFixed(1);
                        const row = document.createElement('tr');
                        if(i === 2 || i === 7 || i === 9) row.className = 'flagship-row';
                        row.innerHTML = `
                            <td><strong>#${i}</strong></td>
                            <td>${initial.size}</td>
                            <td>${final.size}</td>
                            <td class="growth-positive">+${growth}%</td>
                        `;
                        performanceTableBody.appendChild(row);
                    }
                }

                function renderCharts() {
                    if (growthChartInstance) growthChartInstance.destroy();
                    if (comparisonChartInstance) comparisonChartInstance.destroy();
                    if (branchChartInstance) branchChartInstance.destroy();

                    document.querySelectorAll('.chart-view').forEach(c => c.classList.remove('active'));
                    
                    Chart.defaults.font.family = "'Plus Jakarta Sans', sans-serif";
                    Chart.defaults.color = '#0077b6';
                    Chart.defaults.font.weight = '500';
                    
                    const tooltipStyles = {
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        backdropFilter: 'blur(10px)',
                        borderColor: 'rgba(255, 255, 255, 0.4)',
                        borderWidth: 1,
                        titleColor: '#023e8a',
                        bodyColor: '#0077b6',
                        padding: 12,
                        cornerRadius: 10,
                        titleFont: { weight: '700', size: 14 },
                        bodyFont: { weight: '500', size: 13 }
                    };

                    const dates = [...new Set(rawData.map(d => d.date))].sort((a,b) => new Date(a).getTime() - new Date(b).getTime());
                    const labels = dates.map(date => {
                        const dayNum = getDayNumber(date);
                        const dateObj = new Date(date);
                        return `Day ${dayNum} (${dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })})`;
                    });
                    const chartColors = ['#00b4d8', '#48cae4', '#90e0ef', '#0077b6', '#023e8a'];

                    if (activeChart === 'timeline') {
                        document.getElementById('view-timeline').classList.add('active');
                        const ctx = document.getElementById('growthChart').getContext('2d');
                        
                        const datasets = selectedPlants.map((plantNo, index) => {
                            const color = chartColors[index % chartColors.length];
                            const plantData = dates.map(date => {
                                const dataPoint = rawData.find(d => d.date === date && d.plantNo === plantNo);
                                return dataPoint ? dataPoint.size : null;
                            });

                            return {
                                label: `Plant #${plantNo}`,
                                data: plantData,
                                borderColor: color,
                                backgroundColor: color + '20',
                                tension: 0.3,
                                borderWidth: (plantNo === 2 || plantNo === 9) ? 4 : 3,
                                pointRadius: (plantNo === 2 || plantNo === 9) ? 6 : 5,
                                pointBackgroundColor: color,
                                pointBorderColor: 'white',
                                pointBorderWidth: 2,
                                spanGaps: true,
                                fill: false
                            };
                        });

                        growthChartInstance = new Chart(ctx, { 
                            type: 'line', 
                            data: { labels, datasets }, 
                            options: { 
                                responsive: true, maintainAspectRatio: false,
                                scales: { 
                                    y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.1)', drawBorder: false }, ticks: { color: '#0077b6', font: { weight: '600' } }, title: { display: true, text: 'Height (cm)', color: '#023e8a', font: { weight: '700', size: 14 } } },
                                    x: { grid: { color: 'rgba(0,0,0,0.05)', drawBorder: false }, ticks: { color: '#0077b6', font: { weight: '600' }, maxRotation: 45 } }
                                }, 
                                interaction: { intersect: false, mode: 'index' }, 
                                plugins: { tooltip: { ...tooltipStyles }, legend: { labels: { usePointStyle: true, color: '#023e8a', font: { weight: '600' }, padding: 15 } } },
                                elements: { line: { tension: 0.3 }, point: { hoverRadius: 8 } }
                            }
                        });

                    } else if (activeChart === 'comparison') {
                        document.getElementById('view-comparison').classList.add('active');
                        const ctx = document.getElementById('comparisonChart').getContext('2d');
                        const finalData = latestDataAll;
                        
                        const labels = finalData.map(d => `Plant #${d.plantNo}`);
                        const data = finalData.map(d => d.size);
                        const backgroundColors = finalData.map(d => (d.plantNo === 2 || d.plantNo === 9 || d.plantNo === 7) ? '#48cae4' : d.size > 50 ? '#00b4d8' : d.size > 30 ? '#0077b6' : '#90e0ef');
                        
                        comparisonChartInstance = new Chart(ctx, { 
                            type: 'bar', 
                            data: { labels, datasets: [{ label: 'Current Height (cm)', data, backgroundColor: backgroundColors, borderColor: backgroundColors.map(c => c.replace('ef', 'cc')), borderWidth: 2, borderRadius: 8, borderSkipped: false }] }, 
                            options: { 
                                responsive: true, maintainAspectRatio: false,
                                scales: { 
                                    y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.1)', drawBorder: false }, ticks: { color: '#0077b6', font: { weight: '600' } }, title: { display: true, text: 'Height (cm)', color: '#023e8a', font: { weight: '700', size: 14 } } },
                                    x: { grid: { display: false }, ticks: { color: '#0077b6', font: { weight: '600' }, maxRotation: 45 } }
                                }, 
                                plugins: { legend: { display: false }, tooltip: { ...tooltipStyles, callbacks: { title: (c) => c[0].label, label: (c) => `Height: ${c.parsed.y} cm` } } },
                                elements: { bar: { borderWidth: 2 } }
                            }
                        });

                    } else if (activeChart === 'branches') {
                        document.getElementById('view-branches').classList.add('active');
                        const ctx = document.getElementById('branchChart').getContext('2d');

                        const datasets = selectedPlants.map((plantNo, index) => {
                            const color = chartColors[index % chartColors.length];
                            const branchData = dates.map(date => {
                                const dataPoint = rawData.find(d => d.date === date && d.plantNo === plantNo);
                                return dataPoint ? dataPoint.branches : null;
                            });

                            return {
                                label: `Plant #${plantNo}`,
                                data: branchData,
                                borderColor: color,
                                backgroundColor: color + '20',
                                tension: 0.3,
                                borderWidth: (plantNo === 2 || plantNo === 9) ? 4 : 3,
                                pointRadius: (plantNo === 2 || plantNo === 9) ? 6 : 5,
                                pointBackgroundColor: color,
                                pointBorderColor: 'white',
                                pointBorderWidth: 2,
                                spanGaps: true,
                                fill: false
                            };
                        });

                        branchChartInstance = new Chart(ctx, {
                            type: 'line',
                            data: { labels, datasets },
                            options: {
                                responsive: true, maintainAspectRatio: false,
                                scales: {
                                    y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.1)', drawBorder: false }, ticks: { color: '#0077b6', font: { weight: '600' } }, title: { display: true, text: 'Branch Count', color: '#023e8a', font: { weight: '700', size: 14 } } },
                                    x: { grid: { color: 'rgba(0,0,0,0.05)', drawBorder: false }, ticks: { color: '#0077b6', font: { weight: '600' }, maxRotation: 45 } }
                                },
                                interaction: { intersect: false, mode: 'index' },
                                plugins: { tooltip: { ...tooltipStyles }, legend: { labels: { usePointStyle: true, color: '#023e8a', font: { weight: '600' }, padding: 15 } } },
                                elements: { line: { tension: 0.3 }, point: { hoverRadius: 8 } }
                            }
                        });
                    }

                    setTimeout(() => {
                        if (growthChartInstance) growthChartInstance.resize();
                        if (comparisonChartInstance) comparisonChartInstance.resize();
                        if (branchChartInstance) branchChartInstance.resize();
                    }, 100);
                }
                
                chartToggleContainer.addEventListener('click', (e) => {
                    if (e.target.matches('.toggle-button')) {
                        activeChart = e.target.dataset.chart;
                        chartToggleContainer.querySelectorAll('.toggle-button').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                        renderCharts();
                    }
                });

                plantSelectorContainer.addEventListener('click', (e) => {
                    if(e.target.matches('.plant-button')) {
                        const plantNo = parseInt(e.target.dataset.plantNo);
                        if (selectedPlants.includes(plantNo)) {
                            if (selectedPlants.length > 1) {
                                selectedPlants = selectedPlants.filter(p => p !== plantNo);
                            }
                        } else {
                            if (selectedPlants.length < 5) {
                                selectedPlants.push(plantNo);
                            }
                        }
                        renderPlantSelector();
                        renderCharts();
                    }
                });

                try {
                    renderMetrics();
                    renderPlantSelector();
                    renderPerformanceTable();
                    renderCharts();
                } catch (error) {
                    console.error('Dashboard initialization error:', error);
                }
                
                let resizeTimeout;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(() => {
                        if (growthChartInstance) growthChartInstance.resize();
                        if (comparisonChartInstance) comparisonChartInstance.resize();
                        if (branchChartInstance) branchChartInstance.resize();
                    }, 250);
                });
            }
        });
    </script>
</body>
</html>